# Source Linked Asset  
Specification v1

---

## 1. 目的

Source Linked Asset は、Unity Editor において  
**外部ツールで管理されている元ファイル（ソース）** と  
**Unity プロジェクト内のインポート済みアセット** を明示的に関連付ける仕組みを提供する。

本ツールの目的は、

- Unity 上のアセットを「コピー」であると明確に扱うこと
- 外部ソースを基準に、安全かつ再現性のある再インポートを可能にすること

である。

本仕様書は **v1 の確定仕様** を定義する。  
記載内容はすべて現行実装に基づく。

---

## 2. 基本コンセプト

- Unity に存在するアセットは常に外部のオリジナルソースのコピーである
- オリジナルは外部ツール側に存在する
- 再インポートとは、Unity 側の変更を保持する操作ではない
- 外部ソースの状態を Unity アセットに同期させる操作である

---

## 3. 想定ユーザー

- Unity を使用する個人開発者・小規模チーム
- DCC / 音声 / 画像編集ツールと Unity を並行して使用する開発者
- Unreal Engine の Reimport ワークフローに慣れているユーザー

---

## 4. 基本ワークフロー

### 初回インポート

1. ユーザーは外部ファイルを Unity に取り込む
2. ファイルは、Project View で選択されているフォルダにコピーされる  
   （未選択時は Asset 直下）
3. コピーされたファイルは Unity アセットとしてインポートされる
4. アセットには「外部ソースとのリンク情報」が保存される

### 以降の運用

- Unity 上のアセットは、常に外部ソース情報を保持する
- ユーザー操作により、外部ソースを基準に再インポートできる

---

## 5. データの保存場所と責務

Source Linked Asset は、用途ごとに保存場所を明確に分離する。

### ProjectSettings（プロジェクト共通）

- ソースルート定義
  - rootId
  - 表示名
- プロジェクト全員で共有される
- バージョン管理対象

### UserSettings（ユーザーごと）

- rootId → 実ファイルパスの対応
- ユーザーのローカル環境に依存する情報
- バージョン管理対象外

### Asset（.meta / AssetImporter.userData）

- アセットと外部ソースのリンク情報
- 同期状態を示す情報（hash, timestamp, size など）
- Editor 専用データ
- ビルド成果物には影響しない

---

## 6. アセットとソースの関係

各アセットは、以下の情報を保持する。

- ソースファイルの絶対パス（フォールバック用）
- ソースルートID
- ソースルートからの相対パス
- 最終同期時の情報
  - 更新日時
  - ファイルサイズ
  - ハッシュ
- インポート時の AssetPath

これらは **同期状態を判定するための情報** であり、  
履歴管理やバージョン管理を目的としたものではない。

---

## 7. ソースファイルの解決ルール

再インポート時、ソースファイルは以下の優先順位で解決される。

1. `sourceRootId + 相対パス`
2. `absolute path`（フォールバック）

`sourceRootId + 相対パス` による解決を最優先とする。  
複数のソースルートが一致する場合は、  
**ディレクトリ階層が最も深い（最も具体的な）ルート**を採用する。

1 が解決できない場合のみ 2 を使用する。  
両方解決できない場合、再インポートは失敗する。

---

## 8. Reimport の定義

Reimport とは、  
**外部ソースを基準に Unity アセットを同期状態へ更新する操作** である。

### 処理内容

- 外部ソースの内容を検査する
- 前回同期時の情報と比較する

### 判定結果

- 外部ソースの内容が同一の場合  
  - ファイルコピーは行わない  
  - AssetDatabase の再インポートは行わない  
  - 処理はスキップされる

- 外部ソースの内容が変更されている場合  
  - ソースファイルを Asset 配下へコピーする  
  - Unity に再インポートさせる  
  - 同期情報を更新する

---

## 9. Relink（ソース再指定）

ユーザーは、明示的にソースファイルを選択し、  
アセットとソースのリンク情報を更新できる。

### 動作

- 新しいソースファイルを指定する
- ソースルート情報と相対パスを再評価する
- 絶対パス情報を更新する

### 内容一致時

- ファイルコピーは行わない
- リンク情報と同期情報のみ更新する

### 内容不一致時

- Reimport と同様の処理を行う

---

## 10. UX 方針

- Unity 標準の操作感をできるだけ維持する
- 特別なワークフローを強制しない
- 主な操作は以下で完結する
  - ドラッグ＆ドロップ
  - 右クリックメニュー
  - Inspector

---

## 11. 非目標（スコープ外）

- ランタイムでのソース管理
- アセットの履歴管理・バージョン管理
- 自動・監視ベースの再インポート
- Unity AssetDatabase の置き換え

---

## 12. 到達点

- Unity に「外部ソース基準」という概念を自然に導入する
- Reimport ワークフローを明示的かつ安全に提供する
- パス依存による破綻を最小限に抑えた、実運用向きの設計とする
